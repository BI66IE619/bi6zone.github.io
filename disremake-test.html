<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Guaranteed Working WebRTC Voice</title>
<script src="https://cdn.scaledrone.com/scaledrone.min.js"></script>
<style>
body { background:#222; color:white; font-family:sans-serif; padding:20px; }
button { padding:10px 15px; border:none; border-radius:5px; background:#5865F2; color:white; cursor:pointer; }
</style>
</head>
<body>

<h2>Stable WebRTC Voice Test</h2>

<button id="startBtn">Start Voice</button>
<button id="muteBtn" disabled>Mute</button>

<p id="status">Idle</p>

<div id="audioZone"></div>

<script>
const CHANNEL_ID = "YstSSj9UMw4xqYdB";
const ROOM_NAME  = "stable-webrtc-room";

let drone, room;
let pc;
let localStream;
let makingOffer = false;
let ignoreOffer = false;
let polite = false;
let muted = false;

// ------------ START ------------
document.getElementById("startBtn").onclick = async () => {
    try {
        localStream = await navigator.mediaDevices.getUserMedia({ audio:true });
    } catch (e) {
        alert("Mic blocked");
        return;
    }

    initSignaling();
};

// ------------ SIGNALING ------------
function initSignaling() {
    drone = new ScaleDrone(CHANNEL_ID);

    drone.on("open", err => {
        if (err) return console.error(err);
        joinRoom();
    });
}

function joinRoom() {
    room = drone.subscribe(ROOM_NAME);

    room.on("members", members => {
        polite = members.length === 2;
        createPeer();
    });

    room.on("data", (msg, member) => {
        if (!member) return;
        if (member.id === drone.clientId) return;
        handleSignal(msg);
    });
}

// ------------ PEER SETUP ------------
function createPeer() {
    pc = new RTCPeerConnection({
        iceServers:[
            {urls:'stun:stun.l.google.com:19302'},
            {urls:'turn:numb.viagenie.ca', username:'webrtc@live.com', credential:'muazkh'}
        ]
    });

    localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

    pc.ontrack = e => {
        const audio = document.createElement("audio");
        audio.autoplay = true;
        audio.srcObject = e.streams[0];
        document.getElementById("audioZone").appendChild(audio);
    };

    pc.onicecandidate = e => {
        if (e.candidate) sendSignal({candidate:e.candidate});
    };

    pc.onnegotiationneeded = async () => {
        try {
            makingOffer = true;
            await pc.setLocalDescription(await pc.createOffer());
            sendSignal({description:pc.localDescription});
        } finally {
            makingOffer = false;
        }
    };

    document.getElementById("muteBtn").disabled = false;
    document.getElementById("status").textContent = "Ready";
}

// ------------ SIGNAL HANDLING ------------
async function handleSignal(msg) {
    const {description, candidate} = msg;

    try {
        if (description) {
            const offerCollision =
                description.type === "offer" &&
                (makingOffer || pc.signalingState !== "stable");

            ignoreOffer = !polite && offerCollision;
            if (ignoreOffer) return;

            await pc.setRemoteDescription(description);

            if (description.type === "offer") {
                await pc.setLocalDescription(await pc.createAnswer());
                sendSignal({description:pc.localDescription});
            }
        } else if (candidate) {
            if (!ignoreOffer)
                await pc.addIceCandidate(candidate);
        }
    } catch (e) {
        console.error("Signal error:", e);
    }
}

function sendSignal(msg) {
    drone.publish({room:ROOM_NAME, message:msg});
}

// ------------ MUTE ------------
document.getElementById("muteBtn").onclick = () => {
    muted = !muted;
    localStream.getAudioTracks()[0].enabled = !muted;
    document.getElementById("muteBtn").textContent = muted ? "Unmute" : "Mute";
};
</script>

</body>
</html>
