<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>BI6CORD â€” Voice Only</title>
<script src="https://cdn.scaledrone.com/scaledrone.min.js"></script>
<style>
:root{
--bg:#36393F;--sidebar:#2c2d31;--serverbar:#1f1e23;--muted:#96989D;--accent:#5865F2;--card:#232428;--panel:#40444B;--text:#DCDDDE
}
*{box-sizing:border-box;margin:0;padding:0;font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif}
html,body{height:100%;background:var(--bg);color:var(--text)}
.app{display:flex;height:100vh;width:100vw;overflow:hidden}
.server-sidebar{width:72px;background:var(--serverbar);padding:12px 8px;display:flex;flex-direction:column;align-items:center;gap:8px}
.server-icon{width:48px;height:48px;border-radius:24px;background:var(--accent);display:flex;align-items:center;justify-content:center;cursor:pointer}
.nav-icon{width:48px;height:48px;border-radius:24px;background:var(--bg);display:flex;align-items:center;justify-content:center;cursor:pointer}
.nav-icon img,.server-icon img{width:22px;height:22px;filter: invert(1)}
.channel-sidebar{width:260px;background:var(--sidebar);display:flex;flex-direction:column}
.server-header{height:48px;display:flex;align-items:center;padding:0 16px;border-bottom:1px solid #1e1f22;font-weight:600;cursor:pointer}
.channels-container{padding:12px 8px;overflow:auto;flex:1}
.channel-category{padding:8px 8px;font-size:12px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.04em;display:flex;justify-content:space-between;align-items:center}
.channel-item{padding:8px 10px;border-radius:6px;margin:6px 4px;cursor:pointer;color:var(--muted);display:flex;align-items:center;gap:8px}
.channel-item:hover{background:#35373C;color:var(--text)}
.channel-item.active{background:#404249;color:var(--text)}
.voice-indicator{font-size:14px}
.chat-area{flex:1;display:flex;flex-direction:column;background:var(--bg)}
.chat-header{height:64px;display:flex;align-items:center;justify-content:space-between;padding:0 16px;border-bottom:1px solid #1e1f22}
.channel-title{font-weight:700;font-size:18px;display:flex;gap:10px;align-items:center}
.content{flex:1;padding:20px;overflow:auto}
.status-card{background:var(--card);padding:18px;border-radius:10px;border:1px solid #1e1f22;max-width:900px}
.members-sidebar{width:260px;background:var(--sidebar);border-left:1px solid #1e1f22;display:flex;flex-direction:column}
.members-header{height:48px;display:flex;align-items:center;padding:0 16px;border-bottom:1px solid #1e1f22;font-weight:600;color:var(--text)}
.members-content{padding:12px;overflow:auto;flex:1}
.member-item{display:flex;align-items:center;gap:10px;padding:6px 8px;border-radius:6px}
.member-avatar{width:36px;height:36px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:700;color:white}
.member-name{font-size:14px;font-weight:600;color:var(--text)}
.member-presence{font-size:12px;color:var(--muted)}
.controls{display:flex;gap:8px;align-items:center}
.cta-btn{background:var(--accent);color:white;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
audio{width:1px;height:1px;position:absolute;left:-1000px}
@media(max-width:1000px){.members-sidebar{display:none}}
</style>
</head>
<body>
<div class="app">
  <!-- SERVER -->
  <div class="server-sidebar">
    <a class="server-icon"><img src="https://img.icons8.com/ios-filled/50/ffffff/discord-logo.png"/></a>
    <div style="height:8px;"></div>
    <a class="nav-icon"><img src="https://img.icons8.com/ios-filled/50/ffffff/home.png"/></a>
    <a class="nav-icon"><img src="https://img.icons8.com/ios-filled/50/ffffff/controller.png"/></a>
  </div>

  <!-- CHANNELS -->
  <div class="channel-sidebar">
    <div class="server-header">Unblockedcord</div>
    <div class="channels-container">
      <div class="channel-category"><span>Voice Channels</span></div>
      <div class="channel-item voice-channel" vc="voice-lobby" onclick="toggleJoinVoice('voice-lobby')">ðŸ”Š voice-lobby</div>
      <div class="channel-item voice-channel" vc="gaming-vc" onclick="toggleJoinVoice('gaming-vc')">ðŸŽ® gaming-vc</div>
      <div class="channel-item voice-channel" vc="chill-vc" onclick="toggleJoinVoice('chill-vc')">ðŸ˜Ž chill-vc</div>
      <div style="height:14px;"></div>
      <div class="channel-category" style="margin-top:6px;"><span>Presence</span></div>
      <div style="padding:8px;color:var(--muted);font-size:13px;"><span id="presentCount">0</span> users online</div>
    </div>
    <div style="padding:10px;border-top:1px solid #1e1f22;">
      <div style="display:flex;gap:8px;align-items:center;">
        <div id="myAvatar" class="member-avatar">U</div>
        <div style="flex:1;">
          <div id="myName" style="font-weight:700;color:var(--text);font-size:14px;">Connecting...</div>
          <div id="myStatus" style="font-size:12px;color:var(--muted)">Offline</div>
        </div>
        <button id="leaveBtn" class="cta-btn" onclick="leaveVoiceIfJoined()" style="padding:6px 8px;">Leave</button>
        <button id="muteBtn" class="cta-btn" onclick="toggleMute()" style="padding:6px 8px;">Mute</button>
      </div>
    </div>
  </div>

  <!-- MAIN -->
  <div class="chat-area">
    <div class="chat-header">
      <div class="channel-title" id="headerTitle">No voice channel selected</div>
      <div class="controls">
        <div id="vcStatus" style="color:var(--muted)">Not connected</div>
      </div>
    </div>
    <div class="content">
      <div class="status-card">
        <h2>Welcome to Unblockedcord Voice</h2>
        <p style="margin-top:8px;color:var(--muted);line-height:1.45;">
          Click a voice channel to join. Browser will ask for mic permission.
        </p>
      </div>
    </div>
  </div>

  <!-- MEMBERS -->
  <div class="members-sidebar">
    <div class="members-header">Members â€” <span id="membersCountHeader">0</span></div>
    <div class="members-content" id="membersList"></div>
  </div>
</div>

<div id="audioContainer"></div>

<script>
const CLIENT_ID="TnDePK63MJquB3ns"; // replace with your Scaledrone ID
const PRESENCE_ROOM="observable-presence";
const VOICE_ROOM_PREFIX="observable-voice-";
const VOICE_CHANNELS=["voice-lobby","gaming-vc","chill-vc"];

let drone,currentUser,presenceRoom,voiceRoom,localStream,pcs={},joinedChannel=null;
let presenceMembers=new Map(); // id -> clientData
let muted=false;

const membersListEl=document.getElementById('membersList');
const membersCountHeader=document.getElementById('membersCountHeader');
const presentCountEl=document.getElementById('presentCount');
const headerTitle=document.getElementById('headerTitle');
const vcStatus=document.getElementById('vcStatus');
const myNameEl=document.getElementById('myName');
const myStatusEl=document.getElementById('myStatus');
const myAvatarEl=document.getElementById('myAvatar');
const audioContainer=document.getElementById('audioContainer');

function getRandomName(){const a=["quiet","blue","brave","wild","lucky","shadow","crimson","silent","icy","bold"];const b=["river","moon","breeze","pine","cloud","glade","star","ember","dawn","forest"];return a[Math.floor(Math.random()*a.length)]+"_"+b[Math.floor(Math.random()*b.length)];}
function getRandomColor(){let c=Math.floor(Math.random()*0xFFFFFF).toString(16);while(c.length<6)c='0'+c;return '#'+c;}
function shortIdFromName(name){return name.slice(0,1).toUpperCase();}

async function init(){
  currentUser={name:getRandomName(),color:getRandomColor()};
  myNameEl.textContent=currentUser.name;
  myAvatarEl.textContent=shortIdFromName(currentUser.name);
  myAvatarEl.style.background=currentUser.color;

  drone=new Scaledrone(CLIENT_ID,{data:currentUser});
  drone.on('open',err=>{
    if(err){myStatusEl.textContent='Error';return console.error(err);}
    myStatusEl.textContent='Online';
    vcStatus.textContent='Not connected';
    presenceRoom=drone.subscribe(PRESENCE_ROOM);
    presenceRoom.on('members',members=>{presenceMembers.clear();members.forEach(m=>presenceMembers.set(m.id,m.clientData||{}));renderMembers();});
    presenceRoom.on('member_join',m=>{presenceMembers.set(m.id,m.clientData||{});renderMembers();});
    presenceRoom.on('member_leave',m=>{presenceMembers.delete(m.id);renderMembers();});
  });
  drone.on('close',()=>{myStatusEl.textContent='Disconnected';});
  drone.on('error',err=>{myStatusEl.textContent='Error';console.error(err);});
}

function renderMembers(){
  membersListEl.innerHTML='';
  const members=Array.from(presenceMembers.values());
  presentCountEl.textContent=members.length;
  membersCountHeader.textContent=members.length;
  members.forEach(cdata=>{
    const name=cdata.name||'Unknown';
    const color=cdata.color||'#5865F2';
    const el=document.createElement('div');
    el.className='member-item';
    el.innerHTML=`<div class="member-avatar" style="background:${color}">${(name||'U').charAt(0).toUpperCase()}</div>
      <div style="flex:1">
        <div class="member-name">${name}</div>
        <div class="member-presence">Online</div>
      </div>`;
    membersListEl.appendChild(el);
  });
}

async function ensureLocalStream(){if(localStream)return localStream;localStream=await navigator.mediaDevices.getUserMedia({audio:true});return localStream;}

function createPeerConnection(peerId, roomName, initiator=false){
  if(pcs[peerId])return pcs[peerId];
  const pc=new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
  pcs[peerId]=pc;
  if(localStream) localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
  pc.ontrack=evt=>{
    const stream=evt.streams[0];if(!stream)return;
    let audio=document.getElementById('audio-'+peerId);
    if(!audio){audio=document.createElement('audio');audio.id='audio-'+peerId;audio.autoplay=true;audioContainer.appendChild(audio);}
    audio.srcObject=stream;
  };
  pc.onicecandidate=ev=>{if(!ev.candidate)return;drone.publish({room:VOICE_ROOM_PREFIX+roomName,message:{type:'candidate',candidate:ev.candidate,from:drone.clientId}});}
  if(initiator){pc.createOffer().then(o=>pc.setLocalDescription(o).then(()=>drone.publish({room:VOICE_ROOM_PREFIX+roomName,message:{type:'offer',sdp:pc.localDescription,from:drone.clientId}}))).catch(e=>console.warn(e));}
  return pc;
}

async function handleVoiceSignal(message, member, roomName){
  if(!message) return;
  const fromId=(message.from||(member&&member.id));
  if(!fromId||fromId===drone.clientId) return;
  if(!pcs[fromId]) createPeerConnection(fromId,roomName,false);
  const pc=pcs[fromId];
  if(message.type==='offer'&&message.sdp){await ensureLocalStream();if(localStream)localStream.getTracks().forEach(t=>{try{pc.addTrack(t,localStream);}catch(e){}});await pc.setRemoteDescription(new RTCSessionDescription(message.sdp));const ans=await pc.createAnswer();await pc.setLocalDescription(ans);drone.publish({room:VOICE_ROOM_PREFIX+roomName,message:{type:'answer',sdp:pc.localDescription,from:drone.clientId}});}
  else if(message.type==='answer'&&message.sdp){await pc.setRemoteDescription(new RTCSessionDescription(message.sdp));}
  else if(message.type==='candidate'&&message.candidate){await pc.addIceCandidate(new RTCIceCandidate(message.candidate));}
}

async function joinVoiceChannel(roomName){
  if(joinedChannel===roomName){leaveVoiceChannel();return;}
  leaveVoiceChannel();
  if(!drone){alert('Signaling not ready');return;}
  try{await ensureLocalStream();}catch(e){alert('Mic required');return;}
  joinedChannel=roomName;
  headerTitle.textContent=roomName;
  vcStatus.textContent='Connecting...';
  voiceRoom=drone.subscribe(VOICE_ROOM_PREFIX+roomName);
  voiceRoom.on('members',members=>{members.forEach(m=>{if(m.id!==drone.clientId) createPeerConnection(m.id,roomName,true);});});
  voiceRoom.on('member_join',m=>{if(m.id!==drone.clientId) createPeerConnection(m.id,roomName,true);});
  voiceRoom.on('member_leave',m=>{if(pcs[m.id]){pcs[m.id].close();delete pcs[m.id];const a=document.getElementById('audio-'+m.id);if(a)a.remove();}});
  voiceRoom.on('data',(msg,member)=>handleVoiceSignal(msg,member,roomName));
  vcStatus.textContent='Connected to '+roomName;
  document.querySelectorAll('.voice-channel').forEach(el=>el.classList.remove('active'));
  const el=document.querySelector('.voice-channel[vc="'+roomName+'"]');if(el)el.classList.add('active');
}

function leaveVoiceChannel(){
  if(voiceRoom){try{drone.unsubscribe(VOICE_ROOM_PREFIX+joinedChannel);}catch(e){}voiceRoom=null;}
  Object.keys(pcs).forEach(k=>{pcs[k].close();const a=document.getElementById('audio-'+k);if(a)a.remove();delete pcs[k];});
  joinedChannel=null;
  headerTitle.textContent='No voice channel selected';
  vcStatus.textContent='Not connected';
  document.querySelectorAll('.voice-channel').forEach(el=>el.classList.remove('active'));
}

function toggleJoinVoice(name){joinVoiceChannel(name).catch(e=>{console.error(e);alert('Failed: '+(e?.message||'Unknown'));});}
function leaveVoiceIfJoined(){if(joinedChannel)leaveVoiceChannel();}
function promptJoinLast(){if(!joinedChannel&&VOICE_CHANNELS.length)joinVoiceChannel(VOICE_CHANNELS[0]);else if(joinedChannel)leaveVoiceChannel();}
function toggleMute(){if(!localStream) return;muted=!muted;localStream.getAudioTracks().forEach(t=>t.enabled=!muted);document.getElementById('muteBtn').textContent=muted?'Unmute':'Mute';}

window.addEventListener('load',()=>{init();});
</script>
</body>
</html>
