<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Simple WebRTC Voice Chat</title>
<script src="https://cdn.scaledrone.com/scaledrone.min.js"></script>
<style>
body { background:#222; color:white; font-family:sans-serif; padding:20px; }
button { padding:10px 15px; border:none; border-radius:5px; background:#5865F2; color:white; cursor:pointer; }
</style>
</head>
<body>

<h2>Simple WebRTC Voice Chat</h2>
<button id="joinBtn">Join Voice</button>
<button id="muteBtn" disabled>Mute</button>
<p id="status">Not connected</p>

<div id="audio-area"></div>

<script>
// -----------------------
// CONFIG
// -----------------------
const CHANNEL_ID = "YstSSj9UMw4xqYdB";   // your Scaledrone channel
const ROOM_NAME  = "observable-simple-voice-room";

let drone;
let room;
let localStream;
let pc;
let muted = false;

// -----------------------
// JOIN VOICE
// -----------------------
document.getElementById("joinBtn").onclick = async () => {
    document.getElementById("status").textContent = "Requesting microphone...";

    try {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    } catch (e) {
        alert("Microphone blocked.");
        return;
    }

    document.getElementById("status").textContent = "Connecting to Scaledrone...";
    initScaledrone();
};

// -----------------------
// INIT SCALEDONE
// -----------------------
function initScaledrone() {
    drone = new ScaleDrone(CHANNEL_ID);

    drone.on('open', error => {
        if (error) return console.error(error);
        joinRoom();
    });
}

function joinRoom() {
    room = drone.subscribe(ROOM_NAME);

    room.on('open', error => {
        if (error) return console.error(error);
    });

    room.on('members', members => {
        if (members.length >= 2) {
            startWebRTC(true); // we create offer
        }
    });

    room.on('member_join', () => {
        startWebRTC(true);
    });

    room.on('data', (message, member) => {
        if (!member || member.id === drone.clientId) return;
        handleSignaling(message);
    });
}

// -----------------------
// START WEBRTC
// -----------------------
function startWebRTC(isOfferer) {
    pc = new RTCPeerConnection({
        iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: "turn:numb.viagenie.ca", username: "webrtc@live.com", credential: "muazkh" }
        ]
    });

    localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

    pc.ontrack = event => {
        const audio = document.createElement("audio");
        audio.autoplay = true;
        audio.srcObject = event.streams[0];
        document.getElementById("audio-area").appendChild(audio);
    };

    pc.onicecandidate = event => {
        if (event.candidate) {
            drone.publish({
                room: ROOM_NAME,
                message: { type:'candidate', candidate:event.candidate }
            });
        }
    };

    if (isOfferer) {
        pc.onnegotiationneeded = async () => {
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);

            drone.publish({
                room: ROOM_NAME,
                message: { type:'offer', sdp:pc.localDescription }
            });
        };
    }

    document.getElementById("muteBtn").disabled = false;
    document.getElementById("status").textContent = "Connected. Talking...";
}

// -----------------------
// SIGNAL HANDLING
// -----------------------
async function handleSignaling(message) {
    if (!pc) startWebRTC(false);

    switch(message.type) {
        case 'offer':
            await pc.setRemoteDescription(new RTCSessionDescription(message.sdp));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);

            drone.publish({
                room: ROOM_NAME,
                message: { type:'answer', sdp:pc.localDescription }
            });
        break;

        case 'answer':
            await pc.setRemoteDescription(new RTCSessionDescription(message.sdp));
        break;

        case 'candidate':
            if (message.candidate) {
                await pc.addIceCandidate(new RTCIceCandidate(message.candidate));
            }
        break;
    }
}

// -----------------------
// MUTE
// -----------------------
document.getElementById("muteBtn").onclick = () => {
    muted = !muted;
    localStream.getAudioTracks()[0].enabled = !muted;
    document.getElementById("muteBtn").textContent = muted ? "Unmute" : "Mute";
};

</script>
</body>
</html>
