<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Simple Voice Chat</title>
</head>
<body>
    <h2>WebRTC Voice Chat</h2>

    <audio id="remoteAudio" autoplay></audio>

    <script>
        const ROOM_NAME = "voice-room";
        const drone = new ScaleDrone("YstSSj9UMw4xqYdB");
        let room;
        let pc;

        drone.on('open', () => {
            room = drone.subscribe(ROOM_NAME);
            room.on('open', () => console.log("Connected to room"));

            room.on('data', (message, client) => {
                if (client.id === drone.clientId) return;
                handleSignal(message);
            });

            startWebRTC();
        });

        async function startWebRTC() {
            pc = new RTCPeerConnection();

            // Send ICE candidates
            pc.onicecandidate = event => {
                if (event.candidate) {
                    sendSignal({ candidate: event.candidate });
                }
            };

            // Receive audio
            pc.ontrack = event => {
                document.getElementById("remoteAudio").srcObject = event.streams[0];
            };

            // Get microphone
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            stream.getTracks().forEach(track => pc.addTrack(track, stream));

            // If first user â†’ create offer
            room.on("members", members => {
                const isOfferer = members.length === 2;
                if (isOfferer) createOffer();
            });
        }

        async function createOffer() {
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            sendSignal({ offer });
        }

        async function handleSignal(msg) {
            if (msg.offer) {
                await pc.setRemoteDescription(new RTCSessionDescription(msg.offer));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                sendSignal({ answer });
            }

            if (msg.answer) {
                await pc.setRemoteDescription(new RTCSessionDescription(msg.answer));
            }

            if (msg.candidate) {
                try {
                    await pc.addIceCandidate(new RTCIceCandidate(msg.candidate));
                } catch (e) {
                    console.error("ICE error:", e);
                }
            }
        }

        function sendSignal(data) {
            drone.publish({
                room: ROOM_NAME,
                message: data
            });
        }
    </script>

    <script src="https://cdn.scaledrone.com/scaledrone.min.js"></script>
</body>
</html>
