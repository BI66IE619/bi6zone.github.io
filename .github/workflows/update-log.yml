name: Auto Update Log

on:
  push:
    branches:
      - main
      - master

jobs:
  generate-update-log:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: Get Commit Info
        id: commit
        run: |
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$(git log -1 --pretty=%B)" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Get File Diff
        id: diffstep
        run: |
          FILES=$(git diff --name-only HEAD~1 HEAD)
          PATCH=$(git diff HEAD~1 HEAD)

          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "patch<<EOF" >> $GITHUB_OUTPUT
          echo "$PATCH" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate AI Summary (Gemini 2.5 Flash)
        id: ai
        run: |
          PAYLOAD=$(cat << 'EOF'
{
  "contents": [
    {
      "parts": [
        {
          "text": "Summarize the following website updates into a clean update log entry that normal people can read. Avoid coding jargon. Use 2â€“4 bullet points.\n\nFORMAT:\n1. Website version (auto-added later)\n2. Date\n3. Changes (bullet points)\n\nCommit Message:\n${{ steps.commit.outputs.message }}\n\nFiles Changed:\n${{ steps.diffstep.outputs.files }}\n\nPatch:\n${{ steps.diffstep.outputs.patch }}"
        }
      ]
    }
  ]
}
EOF
)

          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${{ secrets.GEMINI_API_KEY }}" )

          SUMMARY=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text')

          echo "summary<<EOF" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Insert Update Into ul.html
        run: |
          VERSION="1.$(date +%m).$(date +%d).$(git rev-parse --short HEAD)"
          TODAY=$(date +"%B %d, %Y")

          NEW_ENTRY=$(cat << 'EOF'
<div class="update-item">
  <h2 class="version-title">Website Version VERSION_REPLACE</h2>
  <p class="version-date">DATE_REPLACE</p>
  <p>SUMMARY_REPLACE</p>
</div>
EOF
)

          NEW_ENTRY="${NEW_ENTRY//VERSION_REPLACE/$VERSION}"
          NEW_ENTRY="${NEW_ENTRY//DATE_REPLACE/$TODAY}"
          NEW_ENTRY="${NEW_ENTRY//SUMMARY_REPLACE/${{ steps.ai.outputs.summary }}}"

          sed -i "/<!-- UPDATE_LOG_START -->/a $NEW_ENTRY" ul.html

      - name: Commit and Push Update Log
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git add ul.html
          git commit -m "Auto-update log entry"
          git push
