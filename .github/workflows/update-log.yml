name: Auto Update Log

on:
  push:
    branches:
      - main

jobs:
  generate-update-log:
    runs-on: ubuntu-latest

    steps:

      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Get latest commit message
        id: commitmsg
        run: |
          MSG=$(git log -1 --pretty=format:"%s%n%n%b")
          {
            echo "msg<<EOF"
            echo "$MSG"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Get git diff
        id: diff
        run: |
          DIFF=$(git show --pretty="" --unified=4)
          {
            echo "diff<<EOF"
            echo "$DIFF"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Build Gemini prompt
        id: prompt
        run: |
          VERSION=$(grep -oP 'v\K[0-9]+\.[0-9]+\.[0-9]+' ul.html | head -n 1)
          if [ -z "$VERSION" ]; then VERSION="1.0.0"; fi

          IFS='.' read -r MAJ MIN PATCH <<< "$VERSION"
          PATCH=$((PATCH + 1))
          NEW_VERSION="$MAJ.$MIN.$PATCH"

          {
            echo "text<<EOF"
            echo "Generate an HTML update block using this template exactly:"
            echo ""
            echo "<div class=\"update-item\" style=\"--delay: 1\">"
            echo "<span class=\"version\">v${NEW_VERSION}</span>"
            echo "<h3>[TITLE]</h3>"
            echo "<p>[DESCRIPTION]</p>"
            echo "</div>"
            echo ""
            echo "Rules:"
            echo "- Keep the class names EXACTLY the same."
            echo "- Replace [TITLE] with a short summary of the commit."
            echo "- Replace [DESCRIPTION] with a simple explanation of the changes."
            echo "- Do NOT add markdown, bullets, or extra formatting."
            echo ""
            echo "Commit Message:"
            echo "${{ steps.commitmsg.outputs.msg }}"
            echo ""
            echo "Git Diff:"
            echo "${{ steps.diff.outputs.diff }}"
            echo ""
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Generate update block using Gemini
        id: gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          JSON=$(jq -n --arg text "${{ steps.prompt.outputs.text }}" \
            '{ contents: [ { parts: [ { text: $text } ] } ] }')

          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "$JSON" \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=$GEMINI_API_KEY")

          OUTPUT=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text')

          {
            echo "result<<EOF"
            echo "$OUTPUT"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Insert update block into ul.html
        run: |
          TMPFILE=$(mktemp)

          awk -v insert="${{ steps.gemini.outputs.result }}" '
            /<h2 class="section-title">Latest Updates<\/h2>/ {
              print;
              print insert "\n";
              next;
            }
            { print }
          ' ul.html > "$TMPFILE"

          mv "$TMPFILE" ul.html

      - name: Commit changes
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add ul.html
          git commit -m "Auto update log entry" || echo "No changes"
          git push
